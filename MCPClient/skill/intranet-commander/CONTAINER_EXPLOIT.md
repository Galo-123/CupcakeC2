# 容器与 K8s 安全审计与加固指南 (Defensive)

本指南用于在**授权范围内**评估容器运行时与 Kubernetes 配置的安全风险，输出整改建议与复测清单。内容聚焦隔离边界、权限最小化、供应链与审计闭环，避免对生产造成影响。

## 1. 评估范围 (Scope)

*   审计对象：镜像仓库、构建流水线、运行时节点、集群控制面、命名空间与关键工作负载。
*   权限：只读优先；任何变更必须走变更流程并准备回滚方案。
*   数据处理：避免采集业务数据内容；证据需脱敏并按留存规则交付。

---

## 2. 运行时隔离与高风险配置 (Runtime Isolation)

### A. 工作负载级别 (Pod/Container)
*   **特权与提权**：是否存在特权容器、是否允许提权、是否以 root 运行。
*   **Capabilities 最小化**：是否按基线收敛 capabilities；是否存在过宽授权的例外项（需有审批与复测）。
*   **文件系统**：是否启用只读根文件系统；是否限制写入目录与挂载点；是否避免写入敏感路径。
*   **安全配置基线**：seccomp/AppArmor/SELinux 是否启用且不处于 unconfined；是否配置 `NoNewPrivileges`（按组织可用性）。
*   **命名空间共享**：是否禁止或严格限制 PID/Network/IPC 与宿主机共享。
*   **挂载治理**：hostPath 挂载是否必要、是否只读、是否禁止敏感路径（如容器运行时 socket、主机根目录等）。

### B. 节点与运行时 (Node/Runtime)
*   **补丁基线**：容器运行时与内核是否满足补丁与基线要求；是否定期升级并验证修复。
*   **管理面暴露**：kubelet/运行时守护进程监听地址与访问控制是否最小化；是否有明确的跳板与审计。
*   **日志与审计**：容器/节点日志是否集中化；关键安全事件是否有告警闭环。

---

## 3. 供应链与镜像治理 (Supply Chain)

*   **来源与签名**：镜像来源是否受控；是否启用签名验证与准入（按组织标准）。
*   **漏洞与 SBOM**：是否启用镜像扫描、SBOM 生成与制品追踪；是否有“高危必须阻断”的策略。
*   **密钥管理**：禁止将密钥写入镜像或明文环境变量；使用 Secret 管理并限制读取与轮换。

---

## 4. Kubernetes 特有治理项 (Cluster Controls)

*   **RBAC**：最小权限；避免通配符权限与 cluster-admin 滥用；关键角色变更需双人复核。
*   **ServiceAccount**：默认 token 自动挂载策略；按需授权、按需挂载、按计划轮换。
*   **准入与策略**：Pod Security（PSA）与策略引擎（OPA/kyverno 等）落地情况；是否有例外流程与复测。
*   **网络策略**：NetworkPolicy 默认拒绝与分段策略；东西向访问控制是否落地。
*   **审计日志**：开启与集中化；关键事件告警闭环（特权工作负载创建/修改、RBAC 变更、敏感配置变更等）。

---

## 5. 复测清单 (Verification)

*   风险项修复后，对应策略是否生效（准入是否拒绝不合规工作负载）。
*   关键工作负载是否不受影响（资源、延迟、可用性）。
*   日志与告警是否覆盖并能触发预期响应流程。

---

## 6. 关联指南

*   虚拟化与隔离审计：`VIRTUALIZATION_ESCAPE.md`
*   审计操作规范与证据管理：`OPSEC_STEALTH.md`
