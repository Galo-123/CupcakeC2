import{g as V,_ as me,o as L,a as ve,J as W,b as g,c as O,d as u,e as a,w as l,af as _e,T as he,n as ge,q as _,ad as we,ag as ye,t as w,B as S,E as c,I as be,m as f,h as m,u as r,ah as ke,p as A,ae as xe,N as Ce,s as T,Q as J,aa as Be,ai as Te,aj as Me,V as Fe,Z as Se,a4 as Ve,j as De,D as j,ak as Pe}from"./index-DG_0wL7P.js";function Ie(v){return V({url:"/api/files/list",method:"get",params:v})}function ze(v){return V({url:"/api/files/read",method:"get",params:v})}function K(v){return V({url:"/api/files/delete",method:"post",data:v})}function je(v){return V({url:"/api/files/upload",method:"post",data:v,headers:{"Content-Type":"multipart/form-data"}})}const Ee={class:"file-manager","element-loading-text":"正在读取远程文件..."},Ne={class:"toolbar-container"},Re={class:"nav-buttons"},Ue={class:"action-buttons"},$e={style:{display:"flex","align-items":"center","justify-content":"center",height:"100%"}},Le={style:{"font-weight":"500"}},We={style:{display:"flex","align-items":"center","justify-content":"center",height:"100%",cursor:"pointer"}},Oe={class:"status-bar"},Ae={key:0,style:{"margin-left":"20px"}},Je={class:"code-preview"},Ke={__name:"FileManager",props:{clientId:{type:String,required:!0},socket:{type:Object,default:null}},setup(v,{expose:q}){const y=v,M=f([]),s=f(""),b=f(""),p=f(!1),D=f(null),x=f([]),F=f(!1),E=f(""),P=f(!1),N=f(0),R=f(0),G=De(()=>s.value?s.value==="/"||s.value==="."||s.value.endsWith(":\\")||s.value.endsWith(":/"):!0),Q=t=>t?new Date(t>1e11?t:t*1e3).toLocaleString():"-",X=t=>{if(!t||t===0)return"0 B";const e=1024,n=["B","KB","MB","GB"],d=Math.floor(Math.log(t)/Math.log(e));return parseFloat((t/Math.pow(e,d)).toFixed(1))+" "+n[d]},C=async t=>{p.value=!0;try{const e=await Ie({uuid:y.clientId,path:t});e.data&&(M.value=e.data.files||[],e.data.current_path&&(s.value=e.data.current_path,b.value=e.data.current_path))}catch{c.error("读取目录失败")}finally{p.value=!1}},Y=t=>{if(t.is_dir){const e=s.value.includes("/")?"/":"\\";let n=s.value;n!=="."&&!n.endsWith(e)&&(n+=e),n==="."&&(n=""),n+=t.name,C(n)}},Z=()=>{const t=s.value.includes("/")?"/":"\\";let e=s.value+t+"..";C(e)},U=t=>C(t),B=()=>C(s.value),H=t=>{P.value=!0,N.value=t.clientX,R.value=t.clientY},$=()=>{P.value=!1};L(()=>{window.addEventListener("click",$)}),ve(()=>{window.removeEventListener("click",$)});const ee=()=>{D.value&&D.value.click()},te=async t=>{const e=t.target.files[0];if(e){p.value=!0,c.info("正在准备上传...");try{const n=new FormData;n.append("uuid",y.clientId);const d=s.value.includes("/")?"/":"\\";let o=s.value;o!=="."&&!o.endsWith(d)&&(o+=d);const h=(o==="."?"":o)+e.name;n.append("path",h),n.append("file",e),await je(n),c.success("上传成功"),B()}catch{c.error("上传失败")}finally{p.value=!1,t.target.value=""}}},ne=async t=>{if(!t.is_dir){c.info("开始下载...");try{const e=s.value+(s.value.includes("/")?"/":"\\")+t.name,n=await Pe({uuid:y.clientId,path:e}),d=window.URL.createObjectURL(new Blob([n.data])),o=document.createElement("a");o.href=d,o.setAttribute("download",t.name),document.body.appendChild(o),o.click(),document.body.removeChild(o),c.success("下载完成")}catch{c.error("下载失败")}}},ae=async t=>{try{await j.confirm(`确定要删除 ${t.is_dir?"文件夹":"文件"}: ${t.name} 吗?`,"警告",{type:"warning",confirmButtonText:"确定",cancelButtonText:"取消"});const e=I(t.name);await K({uuid:y.clientId,paths:[e]}),c.success("删除指令已发送"),setTimeout(B,500)}catch{}},le=(t,e)=>{t==="preview"&&se(e),t==="download"&&ne(e),t==="delete"&&ae(e)},oe=t=>{x.value=t},I=t=>{const e=s.value.includes("/")?"/":"\\";let n=s.value;return n==="."?t:(n.endsWith(e)||(n+=e),n+t)},se=async t=>{var n,d;if(!/\.(txt|log|conf|ini|cfg|sh|bat|ps1|php|jsp|asp|html|js|css|py|go|c|cpp|h|json|xml|yaml|yml|md)$/i.test(t.name)&&t.size>1024*10)try{await j.confirm("该文件可能不是纯文本且体积较大，预览可能产生乱码。确定要预览吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"})}catch{return}p.value=!0;try{const o=I(t.name),h=await ze({uuid:y.clientId,path:o});h.data&&h.data.content?(E.value=h.data.content,F.value=!0):c.warning("文件内容为空或无法读取")}catch(o){c.error("读取文件内容失败: "+(((d=(n=o.response)==null?void 0:n.data)==null?void 0:d.error)||o.message))}finally{p.value=!1}},ie=async()=>{try{await j.confirm(`确定要删除选中的 ${x.value.length} 个项目吗?`,"警告",{type:"warning",confirmButtonText:"确定",cancelButtonText:"取消"});const t=x.value.map(n=>I(n.name));p.value=!0;const e=await K({uuid:y.clientId,paths:t});c.success("批量删除指令已发送"),setTimeout(B,500)}catch{}finally{p.value=!1}};return q({handleSocketMessage:t=>{try{const e=JSON.parse(t.data);if(e.type==="JSON_DATA"){const n=JSON.parse(e.content);(n.current_path||n.files)&&(M.value=n.files||[],s.value=n.current_path||s.value,b.value=s.value,p.value=!1)}}catch{}}}),L(()=>{C(".")}),(t,e)=>{const n=m("el-button"),d=m("el-button-group"),o=m("el-icon"),h=m("el-input"),k=m("el-table-column"),z=m("el-dropdown-item"),ue=m("el-dropdown-menu"),re=m("el-dropdown"),de=m("el-table"),ce=m("el-dialog"),fe=be("loading");return W((g(),O("div",Ee,[u("div",Ne,[u("div",Re,[a(d,null,{default:l(()=>[a(n,{icon:r(ke),onClick:Z,disabled:G.value,title:"返回上级"},null,8,["icon","disabled"]),a(n,{icon:r(A),onClick:B,title:"刷新"},null,8,["icon"])]),_:1})]),a(h,{modelValue:b.value,"onUpdate:modelValue":e[1]||(e[1]=i=>b.value=i),class:"address-bar",placeholder:"输入路径 (e.g. C:\\Windows\\)",onKeyup:e[2]||(e[2]=_e(i=>U(b.value),["enter"]))},{prefix:l(()=>[a(o,null,{default:l(()=>[a(r(Ce))]),_:1})]),append:l(()=>[a(n,{icon:r(xe),onClick:e[0]||(e[0]=i=>U(b.value))},null,8,["icon"])]),_:1},8,["modelValue"]),u("div",Ue,[a(he,{name:"el-fade-in"},{default:l(()=>[x.value.length>0?(g(),T(n,{key:0,type:"danger",icon:r(J),plain:"",onClick:ie},{default:l(()=>[_("批量删除 ("+w(x.value.length)+")",1)]),_:1},8,["icon"])):S("",!0)]),_:1})])]),u("div",{class:"file-list-container",onContextmenu:ye(H,["prevent"])},[a(de,{data:M.value,style:{width:"100%",height:"100%"},onRowDblclick:Y,onSelectionChange:oe,height:"100%","row-style":{cursor:"pointer"},size:"small","empty-text":"目录为空或读取失败"},{default:l(()=>[a(k,{type:"selection",width:"55",align:"center"}),a(k,{width:"50",align:"center"},{default:l(i=>[u("div",$e,[i.row.is_dir?(g(),T(o,{key:0,size:"20",color:"#E6A23C"},{default:l(()=>[a(r(Be))]),_:1})):(g(),T(o,{key:1,size:"20",color:"#909399"},{default:l(()=>[a(r(Te))]),_:1}))])]),_:1}),a(k,{prop:"name",label:"名称 (Name)","min-width":"300",sortable:"","show-overflow-tooltip":""},{default:l(i=>[u("span",Le,w(i.row.name),1)]),_:1}),a(k,{prop:"mod_time",label:"修改日期",width:"180",sortable:""},{default:l(i=>[_(w(Q(i.row.mod_time)),1)]),_:1}),a(k,{prop:"size",label:"大小",width:"120",sortable:"",align:"right"},{default:l(i=>[_(w(i.row.is_dir?"-":X(i.row.size)),1)]),_:1}),a(k,{label:"操作",width:"100",align:"center"},{default:l(i=>[a(re,{trigger:"click",onCommand:pe=>le(pe,i.row)},{dropdown:l(()=>[a(ue,null,{default:l(()=>[i.row.is_dir?S("",!0):(g(),T(z,{key:0,command:"preview",icon:r(Fe)},{default:l(()=>[...e[5]||(e[5]=[_("预览 (Preview)",-1)])]),_:1},8,["icon"])),i.row.is_dir?S("",!0):(g(),T(z,{key:1,command:"download",icon:r(Se)},{default:l(()=>[...e[6]||(e[6]=[_("下载",-1)])]),_:1},8,["icon"])),a(z,{command:"delete",icon:r(J),style:{color:"#F56C6C"}},{default:l(()=>[...e[7]||(e[7]=[_("删除",-1)])]),_:1},8,["icon"])]),_:2},1024)]),default:l(()=>[u("div",We,[a(o,{color:"#409EFF",size:"18"},{default:l(()=>[a(r(Me))]),_:1})])]),_:2},1032,["onCommand"])]),_:1})]),_:1},8,["data"]),W(u("div",{style:ge({left:N.value+"px",top:R.value+"px"}),class:"context-menu"},[u("div",{class:"menu-item",onClick:ee},[a(o,null,{default:l(()=>[a(r(Ve))]),_:1}),e[8]||(e[8]=_(" 上传文件到当前目录 ",-1))]),u("div",{class:"menu-item",onClick:B},[a(o,null,{default:l(()=>[a(r(A))]),_:1}),e[9]||(e[9]=_(" 刷新 (Refresh) ",-1))])],4),[[we,P.value]])],32),u("div",Oe,[u("span",null,w(M.value.length)+" 个项目",1),s.value?(g(),O("span",Ae,"当前: "+w(s.value),1)):S("",!0)]),u("input",{type:"file",ref_key:"fileInputRef",ref:D,style:{display:"none"},onChange:te},null,544),a(ce,{modelValue:F.value,"onUpdate:modelValue":e[4]||(e[4]=i=>F.value=i),title:"文件预览 (Preview - Max 50KB)",width:"60%","destroy-on-close":""},{footer:l(()=>[a(n,{onClick:e[3]||(e[3]=i=>F.value=!1)},{default:l(()=>[...e[10]||(e[10]=[_("关闭",-1)])]),_:1})]),default:l(()=>[u("pre",Je,w(E.value),1)]),_:1},8,["modelValue"])])),[[fe,p.value]])}}},Qe=me(Ke,[["__scopeId","data-v-2fe07f37"]]);export{Qe as default};
