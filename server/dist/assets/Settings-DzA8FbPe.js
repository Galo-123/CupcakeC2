import{_ as ve,o as ce,b as V,c as S,e as l,w as t,g,E as _,h as i,C as T,m as C,I as we,d as a,u as w,S as K,q as n,J as ye,s as M,t as y,M as ke,F as X,r as Y,a6 as Ve,U as Ce,Z as Ue,Q as xe,a7 as Ee,D as h}from"./index-DG_0wL7P.js";const Pe={class:"settings-page"},$e={class:"tab-content"},Ie={class:"section-header"},We={class:"tab-content"},Ae={class:"section-header"},De={class:"webhook-header"},Se={class:"hook-type"},Te=["src"],Me={class:"webhook-body"},Be={class:"hook-url"},je={class:"hook-events"},ze={class:"webhook-footer"},Le={class:"tab-content narrow-content"},Ne={class:"form-tip"},Oe={class:"tab-content"},qe={class:"maintenance-item"},Fe={class:"maintenance-item"},Je={__name:"Settings",setup(Ge){const B=C("users"),P=C(!1),j=C([]),z=C([]),L=C([]),p=T({default_sleep:60,default_jitter:10,system_c2_host:"",system_api_token:"",system_mcp_enabled:"true",opsec_cloak_url:"",allowed_ips:""}),r=T({visible:!1,isEdit:!1,form:{id:null,username:"",password:"",role:"operator"}}),u=T({visible:!1,isEdit:!1,form:{id:null,name:"",type:"dingtalk",url:"",events:""},selectedEvents:["agent_online"]}),k=async()=>{P.value=!0;try{const[s,e,v,d]=await Promise.all([g.get("/api/settings/users"),g.get("/api/settings/logs/login"),g.get("/api/settings/webhooks"),g.get("/api/settings/config")]);j.value=s.data,z.value=e.data,L.value=v.data,d.data.forEach(m=>{p.hasOwnProperty(m.key)&&(["default_sleep","default_jitter"].includes(m.key)?p[m.key]=parseInt(m.value):p[m.key]=m.value)})}catch{_.error("无法加载配置数据")}finally{P.value=!1}},N=(s=null)=>{r.isEdit=!!s,s?r.form={...s,password:""}:r.form={id:null,username:"",password:"",role:"operator"},r.visible=!0},ee=async()=>{try{r.isEdit?(await g.put(`/api/settings/users/${r.form.id}`,r.form),_.success("用户更新成功")):(await g.post("/api/settings/users",r.form),_.success("用户创建成功")),r.visible=!1,k()}catch{_.error("操作失败")}},le=async s=>{try{await g.put(`/api/settings/users/${s.id}`,{is_active:s.is_active}),_.success("状态已更新")}catch{s.is_active=!s.is_active,_.error("更新失败")}},te=s=>{h.confirm(`确定删除用户 ${s.username} 吗？`,"警告",{type:"warning"}).then(async()=>{await g.delete(`/api/settings/users/${s.id}`),_.success("用户已删除"),k()}).catch(()=>{})},O=(s=null)=>{s?(u.form={...s},u.selectedEvents=s.events.split(",")):(u.form={id:null,name:"",type:"dingtalk",url:"",events:""},u.selectedEvents=["agent_online"]),u.visible=!0},oe=async()=>{u.form.events=u.selectedEvents.join(","),await q(u.form),u.visible=!1},q=async s=>{try{await g.post("/api/settings/webhooks",s),_.success("Webhook 已保存"),k()}catch{_.error("保存失败")}},se=s=>{g.delete(`/api/settings/webhooks/${s}`).then(()=>{_.success("已删除"),k()})},ae=s=>({dingtalk:"https://img.icons8.com/color/48/000000/dingtalk.png",feishu:"https://img.icons8.com/color/48/000000/lark.png",slack:"https://img.icons8.com/color/48/000000/slack-new.png",telegram:"https://img.icons8.com/color/48/000000/telegram-app.png"})[s]||"",ne=async()=>{const s=Object.entries(p).map(([e,v])=>{let d="access";return e.startsWith("opsec")?d="opsec":e.startsWith("default")?d="general":e.includes("token")&&(d="security"),{key:e,value:String(v),group:d}});try{await g.post("/api/settings/config",s),_.success("配置已保存")}catch{_.error("保存失败")}},ie=()=>{navigator.clipboard.writeText(p.system_api_token),_.success("Token 已复制到剪贴板")},de=()=>{const s="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()-_=+";let e="";for(let v=0;v<32;v++)e+=s.charAt(Math.floor(Math.random()*s.length));p.system_api_token=e,_.warning("Token 已重置，请点击保存以生效")},re=()=>{window.open("/api/maintenance/export","_blank")},ue=()=>{h.confirm("这清空所有主机记录和命令历史，确定继续吗？","极度危险",{type:"error",confirmButtonText:"确定重置",confirmButtonClass:"el-button--danger"}).then(async()=>{await g.post("/api/maintenance/reset"),_.success("系统已重置"),k()}).catch(()=>{})},F=s=>s?new Date(s).toLocaleString():"-";return ce(k),(s,e)=>{const v=i("el-icon"),d=i("el-button"),m=i("el-table-column"),$=i("el-tag"),I=i("el-switch"),J=i("el-table"),W=i("el-divider"),U=i("el-tab-pane"),x=i("el-card"),A=i("el-col"),G=i("el-row"),Q=i("el-input-number"),f=i("el-form-item"),c=i("el-input"),D=i("el-form"),pe=i("el-alert"),me=i("el-tabs"),R=i("el-option"),fe=i("el-select"),Z=i("el-dialog"),E=i("el-radio-button"),_e=i("el-radio-group"),H=i("el-checkbox"),be=i("el-checkbox-group"),ge=we("loading");return V(),S("div",Pe,[l(x,{shadow:"never",class:"settings-card"},{default:t(()=>[l(me,{modelValue:B.value,"onUpdate:modelValue":e[9]||(e[9]=o=>B.value=o),class:"settings-tabs"},{default:t(()=>[l(U,{name:"users"},{label:t(()=>[l(v,null,{default:t(()=>[l(w(ke))]),_:1}),e[21]||(e[21]=n(" 用户与安全 ",-1))]),default:t(()=>[a("div",$e,[a("div",Ie,[e[23]||(e[23]=a("h3",null,"操作员管理",-1)),l(d,{type:"primary",icon:w(K),onClick:e[0]||(e[0]=o=>N())},{default:t(()=>[...e[22]||(e[22]=[n("新增操员",-1)])]),_:1},8,["icon"])]),ye((V(),M(J,{data:j.value,style:{width:"100%"}},{default:t(()=>[l(m,{prop:"username",label:"用户名",width:"180"}),l(m,{prop:"role",label:"角色",width:"120"},{default:t(o=>[l($,{type:o.row.role==="admin"?"danger":"success"},{default:t(()=>[n(y(o.row.role==="admin"?"管理员":"操作员"),1)]),_:2},1032,["type"])]),_:1}),l(m,{prop:"is_active",label:"状态",width:"100"},{default:t(o=>[l(I,{modelValue:o.row.is_active,"onUpdate:modelValue":b=>o.row.is_active=b,onChange:b=>le(o.row),"active-color":"#13ce66"},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),l(m,{prop:"created_at",label:"创建时间",width:"200"},{default:t(o=>[n(y(F(o.row.created_at)),1)]),_:1}),l(m,{label:"操作",align:"center"},{default:t(o=>[l(d,{link:"",type:"primary",onClick:b=>N(o.row)},{default:t(()=>[...e[24]||(e[24]=[n("修改密码",-1)])]),_:1},8,["onClick"]),l(d,{link:"",type:"danger",onClick:b=>te(o.row),disabled:o.row.username==="admin"},{default:t(()=>[...e[25]||(e[25]=[n("删除",-1)])]),_:1},8,["onClick","disabled"])]),_:1})]),_:1},8,["data"])),[[ge,P.value]]),l(W),e[26]||(e[26]=a("div",{class:"section-header"},[a("h3",null,"登录审计日志")],-1)),l(J,{data:z.value,style:{width:"100%"},size:"small",stripe:""},{default:t(()=>[l(m,{prop:"created_at",label:"时间",width:"180"},{default:t(o=>[n(y(F(o.row.created_at)),1)]),_:1}),l(m,{prop:"username",label:"用户",width:"120"}),l(m,{prop:"ip",label:"登录 IP",width:"140"}),l(m,{prop:"status",label:"状态",width:"100"},{default:t(o=>[l($,{type:o.row.status==="success"?"success":"danger",size:"small"},{default:t(()=>[n(y(o.row.status==="success"?"成功":"失败"),1)]),_:2},1032,["type"])]),_:1}),l(m,{prop:"user_agent",label:"浏览器/UA","show-overflow-tooltip":""})]),_:1},8,["data"])])]),_:1}),l(U,{name:"notifications"},{label:t(()=>[l(v,null,{default:t(()=>[l(w(Ve))]),_:1}),e[27]||(e[27]=n(" 通知配置 ",-1))]),default:t(()=>[a("div",We,[a("div",Ae,[e[29]||(e[29]=a("h3",null,"Webhook 推送",-1)),l(d,{type:"primary",icon:w(K),onClick:e[1]||(e[1]=o=>O())},{default:t(()=>[...e[28]||(e[28]=[n("添加 Webhook",-1)])]),_:1},8,["icon"])]),e[33]||(e[33]=a("div",{class:"notify-tips"}," 系统支持通过 Webhook 将 Agent 上线/断开事件推送到你的即时通讯软件。 ",-1)),l(G,{gutter:20},{default:t(()=>[(V(!0),S(X,null,Y(L.value,o=>(V(),M(A,{span:12,key:o.id},{default:t(()=>[l(x,{shadow:"hover",class:"webhook-card"},{default:t(()=>[a("div",De,[a("div",Se,[a("img",{src:ae(o.type),class:"hook-icon"},null,8,Te),a("span",null,y(o.name),1)]),l(I,{modelValue:o.is_enabled,"onUpdate:modelValue":b=>o.is_enabled=b,onChange:b=>q(o)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),a("div",Me,[a("div",Be,y(o.url),1),a("div",je,[e[30]||(e[30]=n(" 订阅事件: ",-1)),(V(!0),S(X,null,Y(o.events.split(","),b=>(V(),M($,{key:b,size:"small",effect:"plain",style:{"margin-right":"5px"}},{default:t(()=>[n(y(b==="agent_online"?"上线":b==="agent_offline"?"掉线":b),1)]),_:2},1024))),128))])]),a("div",ze,[l(d,{link:"",type:"primary",onClick:b=>O(o)},{default:t(()=>[...e[31]||(e[31]=[n("编辑",-1)])]),_:1},8,["onClick"]),l(d,{link:"",type:"danger",onClick:b=>se(o.id)},{default:t(()=>[...e[32]||(e[32]=[n("删除",-1)])]),_:1},8,["onClick"])])]),_:2},1024)]),_:2},1024))),128))]),_:1})])]),_:1}),l(U,{name:"policies"},{label:t(()=>[l(v,null,{default:t(()=>[l(w(Ce))]),_:1}),e[34]||(e[34]=n(" 全局策 ",-1))]),default:t(()=>[a("div",Le,[e[47]||(e[47]=a("h3",null,"回连策略",-1)),l(D,{"label-position":"left","label-width":"150px"},{default:t(()=>[l(f,{label:"默认心跳 (s)"},{default:t(()=>[l(Q,{modelValue:p.default_sleep,"onUpdate:modelValue":e[2]||(e[2]=o=>p.default_sleep=o),min:1},null,8,["modelValue"]),e[35]||(e[35]=a("div",{class:"form-tip"},"新生成的 Payload 默认使用的心跳间隔。",-1))]),_:1}),l(f,{label:"默认抖动 (%)"},{default:t(()=>[l(Q,{modelValue:p.default_jitter,"onUpdate:modelValue":e[3]||(e[3]=o=>p.default_jitter=o),min:0,max:100},null,8,["modelValue"]),e[36]||(e[36]=a("div",{class:"form-tip"},"心跳时间的随机浮动比例。",-1))]),_:1}),l(W),e[45]||(e[45]=a("h3",null,"OpSec 自身隐藏",-1)),l(f,{label:"默认反连地址"},{default:t(()=>[l(c,{modelValue:p.system_c2_host,"onUpdate:modelValue":e[4]||(e[4]=o=>p.system_c2_host=o),placeholder:"例如: 1.2.3.4 或 c2.domain.com"},null,8,["modelValue"]),e[37]||(e[37]=a("div",{class:"form-tip"},"当监听器绑定 0.0.0.0 时，迁移或生成 Payload 默认使用的反连地址。",-1))]),_:1}),l(f,{label:"404 伪装目标"},{default:t(()=>[l(c,{modelValue:p.opsec_cloak_url,"onUpdate:modelValue":e[5]||(e[5]=o=>p.opsec_cloak_url=o),placeholder:"例如: https://www.google.com"},null,8,["modelValue"]),e[38]||(e[38]=a("div",{class:"form-tip"},"非 API 路径访问时，服务端会自动重定向到该地址。",-1))]),_:1}),l(W),e[46]||(e[46]=a("h3",null,"API 与访问安全",-1)),l(f,{label:"Master API Token"},{default:t(()=>[l(c,{modelValue:p.system_api_token,"onUpdate:modelValue":e[6]||(e[6]=o=>p.system_api_token=o),placeholder:"系统自动生成","show-password":""},{append:t(()=>[l(d,{onClick:ie},{default:t(()=>[...e[39]||(e[39]=[n("复制",-1)])]),_:1})]),_:1},8,["modelValue"]),a("div",Ne,[e[41]||(e[41]=n(" 用于自动化脚本 (MCP) 远程调用 API 的唯一凭证。 ",-1)),l(d,{link:"",type:"primary",size:"small",onClick:de},{default:t(()=>[...e[40]||(e[40]=[n("重置令牌",-1)])]),_:1})])]),_:1}),l(f,{label:"MCP 服务状态"},{default:t(()=>[l(I,{modelValue:p.system_mcp_enabled,"onUpdate:modelValue":e[7]||(e[7]=o=>p.system_mcp_enabled=o),"active-value":"true","inactive-value":"false","active-text":"开启","inactive-text":"关闭"},null,8,["modelValue"]),e[42]||(e[42]=a("div",{class:"form-tip"},"关闭后，所有外部自动化脚本 (MCP) 将无法通过 Token 访问 API。",-1))]),_:1}),l(f,{label:"IP 白名单"},{default:t(()=>[l(c,{type:"textarea",modelValue:p.allowed_ips,"onUpdate:modelValue":e[8]||(e[8]=o=>p.allowed_ips=o),placeholder:"每行一个 IP 或网段"},null,8,["modelValue"]),e[43]||(e[43]=a("div",{class:"form-tip"},"允许访问管理面板的 IP (暂未启用)。",-1))]),_:1}),l(f,null,{default:t(()=>[l(d,{type:"primary",size:"large",onClick:ne},{default:t(()=>[...e[44]||(e[44]=[n("保存全局配置",-1)])]),_:1})]),_:1})]),_:1})])]),_:1}),l(U,{name:"maintenance"},{label:t(()=>[l(v,null,{default:t(()=>[l(w(Ee))]),_:1}),e[48]||(e[48]=n(" 数据维护 ",-1))]),default:t(()=>[a("div",Oe,[l(pe,{title:"危险操作区域",type:"warning",description:"此页面内的操作涉及敏感数据修改或删除，请谨慎操作。","show-icon":"",closable:!1,style:{"margin-bottom":"30px"}}),l(G,{gutter:20},{default:t(()=>[l(A,{span:12},{default:t(()=>[l(x,{header:"数据备份与导出",shadow:"never"},{default:t(()=>[a("div",qe,[e[50]||(e[50]=a("p",null,"将当前数据库中的所有主机信息、操作日志导出为 JSON 格式报告。",-1)),l(d,{type:"primary",icon:w(Ue),onClick:re},{default:t(()=>[...e[49]||(e[49]=[n("立即导出",-1)])]),_:1},8,["icon"])])]),_:1})]),_:1}),l(A,{span:12},{default:t(()=>[l(x,{header:"系统重置",shadow:"never"},{default:t(()=>[a("div",Fe,[e[52]||(e[52]=a("p",null,"清空所有 Agent 记录、命令日志。此操作不会影响操作员账号。",-1)),l(d,{type:"danger",icon:w(xe),onClick:ue},{default:t(()=>[...e[51]||(e[51]=[n("一键重置环境",-1)])]),_:1},8,["icon"])])]),_:1})]),_:1})]),_:1})])]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(Z,{modelValue:r.visible,"onUpdate:modelValue":e[14]||(e[14]=o=>r.visible=o),title:r.isEdit?"修改用户":"新增用户",width:"450px"},{footer:t(()=>[l(d,{onClick:e[13]||(e[13]=o=>r.visible=!1)},{default:t(()=>[...e[53]||(e[53]=[n("取消",-1)])]),_:1}),l(d,{type:"primary",onClick:ee},{default:t(()=>[...e[54]||(e[54]=[n("确认",-1)])]),_:1})]),default:t(()=>[l(D,{model:r.form,"label-width":"100px"},{default:t(()=>[l(f,{label:"用户名"},{default:t(()=>[l(c,{modelValue:r.form.username,"onUpdate:modelValue":e[10]||(e[10]=o=>r.form.username=o),disabled:r.isEdit},null,8,["modelValue","disabled"])]),_:1}),l(f,{label:"密码"},{default:t(()=>[l(c,{modelValue:r.form.password,"onUpdate:modelValue":e[11]||(e[11]=o=>r.form.password=o),type:"password","show-password":"",placeholder:"若不修改请留空"},null,8,["modelValue"])]),_:1}),l(f,{label:"角色"},{default:t(()=>[l(fe,{modelValue:r.form.role,"onUpdate:modelValue":e[12]||(e[12]=o=>r.form.role=o),style:{width:"100%"}},{default:t(()=>[l(R,{label:"管理员",value:"admin"}),l(R,{label:"操作员",value:"operator"})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(Z,{modelValue:u.visible,"onUpdate:modelValue":e[20]||(e[20]=o=>u.visible=o),title:"Webhook 配置",width:"550px"},{footer:t(()=>[l(d,{onClick:e[19]||(e[19]=o=>u.visible=!1)},{default:t(()=>[...e[61]||(e[61]=[n("取消",-1)])]),_:1}),l(d,{type:"primary",onClick:oe},{default:t(()=>[...e[62]||(e[62]=[n("保存",-1)])]),_:1})]),default:t(()=>[l(D,{model:u.form,"label-width":"100px","label-position":"left"},{default:t(()=>[l(f,{label:"名称"},{default:t(()=>[l(c,{modelValue:u.form.name,"onUpdate:modelValue":e[15]||(e[15]=o=>u.form.name=o),placeholder:"例如: 我的钉钉推送"},null,8,["modelValue"])]),_:1}),l(f,{label:"类型"},{default:t(()=>[l(_e,{modelValue:u.form.type,"onUpdate:modelValue":e[16]||(e[16]=o=>u.form.type=o)},{default:t(()=>[l(E,{label:"dingtalk"},{default:t(()=>[...e[55]||(e[55]=[n("钉钉",-1)])]),_:1}),l(E,{label:"feishu"},{default:t(()=>[...e[56]||(e[56]=[n("飞书",-1)])]),_:1}),l(E,{label:"slack"},{default:t(()=>[...e[57]||(e[57]=[n("Slack",-1)])]),_:1}),l(E,{label:"telegram"},{default:t(()=>[...e[58]||(e[58]=[n("Telegram",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(f,{label:"Webhook URL"},{default:t(()=>[l(c,{modelValue:u.form.url,"onUpdate:modelValue":e[17]||(e[17]=o=>u.form.url=o),type:"textarea",rows:3},null,8,["modelValue"])]),_:1}),l(f,{label:"订阅事件"},{default:t(()=>[l(be,{modelValue:u.selectedEvents,"onUpdate:modelValue":e[18]||(e[18]=o=>u.selectedEvents=o)},{default:t(()=>[l(H,{label:"agent_online"},{default:t(()=>[...e[59]||(e[59]=[n("Agent 上线",-1)])]),_:1}),l(H,{label:"agent_offline"},{default:t(()=>[...e[60]||(e[60]=[n("Agent 掉线",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},Re=ve(Je,[["__scopeId","data-v-d0c4dfcd"]]);export{Re as default};
