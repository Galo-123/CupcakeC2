import{_ as z,o as G,a as se,b as y,c as T,d as S,m as U,e as g,w as C,u as F,S as ie,B as L,F as W,r as j,h as E,C as ce,s as K,N as fe,q as ue,t as de,J as pe,ad as me,ae as be,af as he,E as q,g as ye}from"./index-DG_0wL7P.js";import{x as _e,a as ge}from"./xterm-nVmz_L2e.js";const we={class:"terminal-wrapper"},ke="__CUPCAKE_DONE__",xe={__name:"WebTerminal",props:{socket:Object,clientId:String,allowPTY:{type:Boolean,default:!1}},setup(v,{expose:A}){const w=v,u=U(null);let n=null,p=null,s=null,_="",m="unknown",f="",i=-1,O=!1,N="> ",l="";const o=[];let b=!1,M=0;const I=[],P=[],k=()=>`terminal_history_${w.clientId}`,c=()=>{try{localStorage.setItem(k(),JSON.stringify(I.slice(-1e3)))}catch{}},x=()=>{try{const t=localStorage.getItem(k());if(t){const e=JSON.parse(t);Array.isArray(e)&&e.forEach(a=>n&&n.write(a))}}catch{}},R=t=>{if(!t)return;const e=String(t).replace(/\r?\n/g,`\r
`);if(!n){P.push(e);return}n.write(e),I.push(e),c()},Q=()=>{!n||P.length===0||P.splice(0).forEach(t=>n.write(t))},X=t=>{try{const e=JSON.parse(t);if(e&&e.type==="PTY_MODE"){e.content==="fallback"&&(m="fallback",O||(n.writeln("\x1B[33m[Line Mode] 回车发送，↑/↓ 历史，Ctrl+L 清屏，Ctrl+U 清空当前行\x1B[0m"),O=!0));return}if(e&&e.type==="PTY_DONE"){m!=="yamux"&&(m="fallback",ne());return}if(e&&e.type==="TERM"){m="fallback",e.content!==void 0&&e.content!==null&&H(String(e.content));return}if(e&&e.type==="JSON_DATA"){m="fallback",console.log("[PTY] Received JSON data, filtering from terminal.");return}if(e&&e.content!==void 0&&e.content!==null){m="fallback",H(String(e.content));return}}catch{}n.write(t)},J=t=>{if(!t)return;_+=String(t);const e=_;let a=0,r=-1,d=0,Y=!1,V=!1,$=0;for(;a<e.length;){const h=e[a];if(r===-1)if(h==="{"||h==="[")r=a,d=0;else{a++;continue}if(Y){V?V=!1:h==="\\\\"?V=!0:h==='"'&&(Y=!1),a++;continue}if(h==='"'){Y=!0,a++;continue}if(h==="{"||h==="[")d++;else if((h==="}"||h==="]")&&(d--,d===0&&r!==-1)){const re=e.slice(r,a+1);X(re),$=a+1,r=-1}a++}if(r!==-1||d>0){_=e.slice(r);return}if($>0){_=e.slice($);return}n.write(e),_=""},B=()=>{if(f){for(let t=0;t<f.length;t++)n.write("\b \b");f=""}},D=t=>{B(),f=t,t&&n.write(t)},Z=t=>{const e=String(t||"").trim();if(!e){i=-1;return}(o.length===0||o[o.length-1]!==e)&&o.push(e),o.length>100&&o.shift(),i=-1},ee=()=>{o.length!==0&&(i===-1?i=o.length-1:i>0&&(i-=1),D(o[i]))},te=()=>{if(i!==-1){if(i<o.length-1){i+=1,D(o[i]);return}i=-1,D("")}},ne=()=>{if(f.length>0)return;const t=Date.now();b&&t-M<200||(n.write(N),b=!0,M=t)},H=t=>{if(!t)return;b=!1,l+=String(t);const e=l.split(/\r?\n/);l=e.pop()||"";const a=[];for(const r of e){if(!r){a.push(r);continue}if(r.includes(ke))continue;const d=r.trim();d==="@echo off"||d==="echo off"||d==="ECHO is off."||a.push(r)}a.length>0&&n.write(a.join(`\r
`)+`\r
`)},ae=t=>{if(!t)return;const e=String(t);if(e==="\x1B[A"){ee();return}if(e==="\x1B[B"){te();return}if(!(e==="\x1B[C"||e==="\x1B[D")&&!e.startsWith("\x1B"))for(const a of e){if(a===""){B();continue}if(a==="\f"){n.clear(),B();continue}if(a===""){B(),n.write(`^C\r
`);continue}if(a==="\r"||a===`
`){n.write(`\r
`),s&&s.readyState===WebSocket.OPEN&&(Z(f),s.send(f+`
`)),f="";continue}if(a===""||a==="\b"){f.length>0&&(f=f.slice(0,-1),n.write("\b \b")),i!==-1&&(i=-1);continue}f+=a,n.write(a),b=!1,i!==-1&&(i=-1)}},oe=()=>{const t=localStorage.getItem("cupcake_token"),a=`${window.location.protocol==="https:"?"wss":"ws"}://${window.location.host}/api/pty/${w.clientId}?token=${encodeURIComponent(t)}`;s=new WebSocket(a),s.binaryType="arraybuffer",s.onopen=()=>{n.writeln(`\x1B[1;32m[+] Interactive PTY Connected.\x1B[0m\r
`),n.focus()},s.onmessage=r=>{if(r.data instanceof ArrayBuffer){m="yamux",n.write(new Uint8Array(r.data));return}if(r.data instanceof Blob){r.data.text().then(d=>J(d));return}J(r.data)},s.onclose=()=>{n.writeln(`\r
\x1B[1;31m[!] PTY Session Closed.\x1B[0m`)},s.onerror=()=>{n.writeln(`\r
\x1B[1;31m[!] PTY Connection Error.\x1B[0m`)},n.onData(r=>{if(s&&s.readyState===WebSocket.OPEN){if(m==="fallback"){ae(r);return}s.send(r)}})},le=()=>{n=new _e.Terminal({cursorBlink:!0,fontSize:14,fontFamily:'"Consolas", "Monaco", monospace',fontWeight:"normal",allowTransparency:!0,scrollback:5e3,theme:{background:"#000000",foreground:"#d4d4d4",cursor:"#007acc"}}),p=new ge.FitAddon,n.loadAddon(p),n.open(u.value),p.fit(),w.allowPTY?oe():(x(),localStorage.getItem(k())||n.writeln("\x1B[1;37m[System] Terminal Ready.\x1B[0m")),Q()};return A({handleSocketMessage:t=>{if(w.allowPTY||!t||!t.data)return;let e="TERM",a=t.data;if(typeof a=="string")try{const r=JSON.parse(a);r&&r.type&&(e=r.type,a=r.content??"")}catch{}e==="TERM"&&(a instanceof ArrayBuffer?R(new TextDecoder().decode(new Uint8Array(a))):R(a))},clearHistory:()=>{I.length=0;try{localStorage.removeItem(k())}catch{}}}),G(()=>{le(),window.addEventListener("resize",()=>p&&p.fit())}),se(()=>{s&&s.close(),n&&n.dispose()}),(t,e)=>(y(),T("div",we,[S("div",{ref_key:"terminalContainer",ref:u,class:"terminal-container"},null,512)]))}},Te=z(xe,[["__scopeId","data-v-df7ff5ae"]]),Se={class:"terminal-tabs-container"},ve={class:"tabs-header"},Ie={class:"tab-label"},Pe={class:"terminal-content"},Ce={key:0,style:{padding:"40px","text-align":"center",color:"#666"}},Ee={class:"terminal-box"},Oe={class:"terminal-display-wrapper"},Me={__name:"TerminalTabs",props:{clientId:{type:String,required:!0},clientInfo:{type:Object,default:null},socket:{type:Object,default:null}},setup(v,{expose:A}){const w=v,u=U([]),n=U("");let p=0;const s=ce({}),_=(l,o)=>{o&&(s[l]=o)},m=l=>{Object.values(s).forEach(o=>{o&&o.handleSocketMessage&&o.handleSocketMessage(l)})},f=(l=!1)=>{p++;const o=`session-${Date.now()}-${p}`;return{name:o,title:l?`Interactive PTY ${p}`:`Shell ${p}`,sessionId:o,isPTY:l,input:"",submitting:!1}},i=()=>{const l=f(!0);u.value.push(l),n.value=l.name},O=l=>{if(u.value.length===1){q.warning("至少保留一个终端");return}const o=u.value.findIndex(b=>b.name===l);o!==-1&&(u.value.splice(o,1),delete s[l],n.value===l&&(n.value=u.value[Math.max(0,o-1)].name))},N=async l=>{if(!l.input.trim())return;const o=l.input;l.input="",l.submitting=!0;try{await ye.post("/api/cmd",{uuid:w.clientId,cmd:o,session_id:l.sessionId})}catch{q.error("鍛戒护涓嬪彂澶辫触")}finally{l.submitting=!1}};return G(()=>{console.log("[TerminalTabs] onMounted called, creating first tab...");const l=f(!0);l.title="Interactive Shell",u.value.push(l),n.value=l.name,console.log("[TerminalTabs] First tab created, tabs:",u.value)}),A({handleSocketMessage:m}),(l,o)=>{const b=E("el-icon"),M=E("el-tab-pane"),I=E("el-tabs"),P=E("el-button"),k=E("el-input");return y(),T("div",Se,[S("div",ve,[g(I,{modelValue:n.value,"onUpdate:modelValue":o[0]||(o[0]=c=>n.value=c),type:"border-card",closable:"",onTabRemove:O,class:"terminal-tabs"},{default:C(()=>[(y(!0),T(W,null,j(u.value,c=>(y(),K(M,{key:c.name,label:c.title,name:c.name},{label:C(()=>[S("span",Ie,[g(b,null,{default:C(()=>[g(F(fe))]),_:1}),ue(" "+de(c.title),1)])]),_:2},1032,["label","name"]))),128))]),_:1},8,["modelValue"]),g(P,{type:"primary",icon:F(ie),circle:"",size:"small",onClick:i,class:"add-tab-btn",title:"鏂板缓缁堢"},null,8,["icon"])]),S("div",Pe,[u.value.length===0?(y(),T("div",Ce," Loading terminal... If you see this, onMounted hasn't run yet. ")):L("",!0),(y(!0),T(W,null,j(u.value,c=>pe((y(),T("div",{key:c.name,class:"terminal-instance"},[S("div",Ee,[S("div",Oe,[g(Te,{ref_for:!0,ref:x=>_(c.name,x),socket:v.socket,"client-id":v.clientId,"allow-p-t-y":c.isPTY},null,8,["socket","client-id","allow-p-t-y"])]),c.isPTY?L("",!0):(y(),K(k,{key:0,modelValue:c.input,"onUpdate:modelValue":x=>c.input=x,placeholder:"杈撳叆 Shell 鍛戒护骞跺洖杞?..",onKeyup:he(x=>N(c),["enter"]),disabled:c.submitting,class:"terminal-input-bar"},{prefix:C(()=>[g(b,null,{default:C(()=>[g(F(be))]),_:1})]),_:1},8,["modelValue","onUpdate:modelValue","onKeyup","disabled"]))])])),[[me,n.value===c.name]])),128))])])}}},Ye=z(Me,[["__scopeId","data-v-36cae86e"]]);export{Ye as default};
